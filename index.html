<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Futures Bot v10.5 - Panel Profesional</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #111827; 
            --bg-light: #F9FAFB; 
            --primary: #1F2937; 
            --secondary: #4B5563; 
            --accent: #3B82F6; 
            --success: #10B981; 
            --danger: #EF4444; 
            --warning: #F59E0B; 
            --text-light: #D1D5DB; 
            --text-dark: #111827; 
            --border: #E5E7EB;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --bg-dark: #F9FAFB;
            --bg-light: #111827;
            --primary: #F3F4F6;
            --secondary: #E5E7EB;
            --accent: #60A5FA;
            --text-light: #1F2937;
            --text-dark: #D1D5DB;
            --border: #374151;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-dark); 
            margin: 0; 
            line-height: 1.6;
            transition: var(--transition);
        }

        .container { 
            max-width: 1800px; 
            margin: 2rem auto; 
            padding: 0 2rem; 
        }

        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1.5rem; 
            background: var(--primary);
            color: var(--text-light);
            border-radius: 1rem; 
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .header h1 { 
            font-size: 1.5rem; 
            margin: 0; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
        }

        .header h1 i { 
            color: var(--accent); 
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .status-indicator { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            font-weight: 600; 
        }

        .status-dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background-color: var(--secondary); 
            transition: background-color 0.3s; 
            position: relative;
        }

        .status-dot.running { 
            background-color: var(--success);
            animation: pulse 2s infinite;
        }

        .btn { 
            padding: 0.6rem 1.2rem; 
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 600; 
            transition: var(--transition); 
            display: inline-flex; 
            align-items: center; 
            gap: 0.5rem; 
        }

        .btn i { 
            font-size: 0.9em; 
        }

        .btn-primary { 
            background-color: var(--accent); 
            color: white; 
        }

        .btn-primary:hover { 
            background-color: #2563EB; 
            transform: translateY(-2px);
        }

        .btn-danger { 
            background-color: var(--danger); 
            color: white; 
        }

        .btn-danger:hover { 
            background-color: #DC2626; 
            transform: translateY(-2px);
        }

        .btn-secondary { 
            background-color: var(--secondary); 
            color: white; 
        }

        .btn-secondary:hover {
            background-color: #374151;
            transform: translateY(-2px);
        }

        .btn-sm { 
            padding: 0.3rem 0.6rem; 
            font-size: 0.8rem; 
        }

        .btn:disabled { 
            background-color: #9CA3AF; 
            cursor: not-allowed; 
            transform: none !important;
        }

        .loader { 
            width: 16px; 
            height: 16px; 
            border: 2px solid #FFF; 
            border-bottom-color: transparent; 
            border-radius: 50%; 
            display: inline-block; 
            box-sizing: border-box; 
            animation: spin 1s linear infinite; 
        }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 1.5rem; 
            margin-bottom: 2rem; 
        }

        .stat-card { 
            background: var(--primary);
            color: var(--text-light);
            border-radius: 1rem; 
            padding: 1.5rem; 
            box-shadow: var(--card-shadow);
            animation: fadeIn 0.5s ease-out;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), transparent);
        }

        .stat-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .stat-title {
            font-size: 0.9rem;
            color: var(--text-light);
            opacity: 0.8;
        }

        .stat-value { 
            font-size: 1.8rem; 
            font-weight: 700; 
            margin-bottom: 0.5rem;
        }

        .stat-footer {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-light);
            opacity: 0.8;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            margin-right: 0.5rem;
        }

        .positive { 
            color: var(--success); 
        }

        .negative { 
            color: var(--danger); 
        }

        .main-grid { 
            display: grid; 
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem; 
        }

        .grid-col-span-6 { 
            grid-column: span 6;
        }

        .grid-col-span-4 {
            grid-column: span 4;
        }

        .grid-col-span-8 {
            grid-column: span 8;
        }

        .grid-col-span-12 {
            grid-column: span 12;
        }

        .card { 
            background: var(--primary);
            color: var(--text-light);
            border-radius: 1rem; 
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1.25rem 1.5rem; 
            border-bottom: 1px solid var(--border);
        }

        .card-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin: 0; 
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .card-body { 
            padding: 1.5rem;
            flex-grow: 1;
            overflow: auto;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
        }

        th, td { 
            padding: 1rem; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.9rem; 
        }

        th { 
            background-color: rgba(0, 0, 0, 0.1); 
            font-weight: 600; 
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .log-container { 
            height: 400px; 
            overflow-y: auto; 
            background: rgba(0, 0, 0, 0.2); 
            color: var(--text-light); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            font-family: 'Fira Code', monospace; 
            font-size: 0.85rem; 
        }

        .log-container div { 
            padding: 0.2rem 0; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-container div:last-child {
            border-bottom: none;
        }

        .log-error { 
            color: var(--danger); 
        }

        .log-warning { 
            color: var(--warning); 
        }

        .log-info { 
            color: #93C5FD; 
        }

        .log-success {
            color: var(--success);
        }

        .config-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
        }

        .form-group { 
            display: flex; 
            flex-direction: column; 
        }

        .form-label { 
            font-size: 0.8rem; 
            margin-bottom: 0.25rem; 
            color: var(--text-light);
            opacity: 0.8;
            font-weight: 500; 
        }

        .form-control { 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            border: 1px solid var(--border); 
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-light);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.7); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.3s; 
        }

        .modal-overlay.visible { 
            opacity: 1; 
            visibility: visible; 
        }

        .modal-content { 
            background: var(--primary); 
            padding: 2rem; 
            border-radius: 1rem; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            color: var(--text-light);
        }

        .modal-actions { 
            display: flex; 
            justify-content: flex-end; 
            gap: 1rem; 
            margin-top: 1.5rem; 
        }

        .toast-container { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 1001; 
        }

        .toast { 
            background: var(--primary); 
            color: white; 
            padding: 1rem 1.5rem; 
            border-radius: 0.5rem; 
            margin-bottom: 1rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0; 
            transform: translateY(20px); 
            transition: all 0.3s; 
        }

        .toast.show { 
            opacity: 1; 
            transform: translateY(0); 
        }

        .toast.success { 
            background: var(--success); 
        }

        .toast.error { 
            background: var(--danger); 
        }

        .toast.info {
            background: var(--accent);
        }

        .toast i {
            font-size: 1.2rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
        }

        .tab.active {
            border-bottom: 2px solid var(--accent);
            color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
        }

        .search-box input {
            background: none;
            border: none;
            color: var(--text-light);
            padding: 0.5rem;
            width: 100%;
            outline: none;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: white;
        }

        .badge-danger {
            background: var(--danger);
            color: white;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .performance-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .performance-card h4 {
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .grid-col-span-6,
            .grid-col-span-4,
            .grid-col-span-8 {
                grid-column: span 1;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
                margin: 1rem auto;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                gap: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .tab-container {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-robot"></i>Binance Futures Bot v10.5</h1>
            <div class="header-actions">
                <div class="status-indicator">
                    <div id="status-dot" class="status-dot"></div>
                    <span id="status-message">Conectando...</span>
                </div>
                <div class="status-indicator">
                    <i class="fas fa-wallet"></i>
                    <span id="header-balance">0.00 USDT</span>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="startBot(this)" id="start-btn"><i class="fas fa-play"></i>Iniciar</button>
                    <button class="btn btn-danger" onclick="stopBot(this)" id="stop-btn"><i class="fas fa-stop"></i>Detener</button>
                    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Balance Total</div>
                    <div class="stat-icon"><i class="fas fa-balance-scale"></i></div>
                </div>
                <div class="stat-value" id="balance-stat">0.00</div>
                <div class="stat-footer">
                    <span>USDT</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Inversi√≥n Actual</div>
                    <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                </div>
                <div class="stat-value" id="investment-stat">0.00</div>
                <div class="stat-footer">
                    <span>En posiciones abiertas</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Posiciones</div>
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                </div>
                <div class="stat-value" id="positions-stat">0/10</div>
                <div class="stat-footer">
                    <span id="positions-footer">Activas: 0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">P&L Abierto</div>
                    <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                </div>
                <div class="stat-value" id="unrealized-pnl-stat">0.00</div>
                <div class="stat-footer">
                    <span>No realizado</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">P&L Realizado</div>
                    <div class="stat-icon"><i class="fas fa-piggy-bank"></i></div>
                </div>
                <div class="stat-value" id="realized-pnl-stat">0.00</div>
                <div class="stat-footer">
                    <span>Total acumulado</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Total Trades</div>
                    <div class="stat-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                </div>
                <div class="stat-value" id="trades-stat">0</div>
                <div class="stat-footer">
                    <span id="trades-footer">G: 0 / P: 0</span>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card grid-col-span-8">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Rendimiento del Bot</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card grid-col-span-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-info-circle"></i> Resumen de Trading</h3>
                </div>
                <div class="card-body">
                    <div class="stats-grid" style="grid-template-columns: 1fr;">
                        <div class="stat-card" style="padding: 1rem;">
                            <div class="stat-header">
                                <div class="stat-title">Ratio de Ganancia</div>
                                <div class="stat-value" id="win-rate-stat">0%</div>
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 1rem;">
                            <div class="stat-header">
                                <div class="stat-title">Average Win</div>
                                <div class="stat-value" id="avg-win-stat">0.00</div>
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 1rem;">
                            <div class="stat-header">
                                <div class="stat-title">Average Loss</div>
                                <div class="stat-value" id="avg-loss-stat">0.00</div>
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 1rem;">
                            <div class="stat-header">
                                <div class="stat-title">Profit Factor</div>
                                <div class="stat-value" id="profit-factor-stat">0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card grid-col-span-6">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-cogs"></i> An√°lisis de Rendimiento</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="loadPerformanceMetrics()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">S√≠mbolo</label>
                        <select id="performance-symbol" class="form-control" onchange="loadPerformanceMetrics()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div id="performance-metrics">
                        <p class="text-center">Cargando an√°lisis de rendimiento...</p>
                    </div>
                </div>
            </div>

            <div class="card grid-col-span-6">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-map-marker-alt"></i> Posiciones Abiertas</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="refreshData()"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="position-search" placeholder="Buscar s√≠mbolo..." oninput="filterPositions()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>S√≠mbolo</th>
                                <th>Lado</th>
                                <th>Tama√±o</th>
                                <th>Entrada</th>
                                <th>Actual</th>
                                <th>P&L (USDT)</th>
                                <th>Trailing Stop</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="positions-tbody">
                            <tr>
                                <td colspan="8" style="text-align:center; padding: 2rem;">Cargando posiciones...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card grid-col-span-12">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history"></i> Historial de Trades</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="tab-container" id="trade-tabs">
                        <div class="tab active" onclick="changeTradeTab(this, '')">Todos</div>
                        <div class="tab" onclick="changeTradeTab(this, 'today')">Hoy</div>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="trade-search" placeholder="Buscar trade por s√≠mbolo..." oninput="filterTrades()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>S√≠mbolo</th>
                                <th>Lado</th>
                                <th>Cantidad</th>
                                <th>P&L</th>
                                <th>ROE</th>
                                <th>Cierre</th>
                            </tr>
                        </thead>
                        <tbody id="trades-tbody">
                            <tr>
                                <td colspan="7" style="text-align:center; padding: 2rem;">No hay trades recientes</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card grid-col-span-12">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-cogs"></i> Configuraci√≥n del Bot</h3>
                </div>
                <div class="card-body">
                    <div class="tab-container" id="config-tabs">
                        <div class="tab active" onclick="changeConfigTab(this, 'global')">Global</div>
                        <div class="tab" onclick="changeConfigTab(this, 'strategy')">Estrategia</div>
                        <div class="tab" onclick="changeConfigTab(this, 'trailing')">Trailing Stop</div>
                        <div class="tab" onclick="changeConfigTab(this, 'manual')">Trading Manual</div>
                    </div>

                    <div id="global-config" class="tab-content active">
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="LEVERAGE">Apalancamiento</label>
                                <input type="number" id="LEVERAGE" class="form-control" min="1" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="MAX_CONCURRENT_POS">Max Posiciones</label>
                                <input type="number" id="MAX_CONCURRENT_POS" class="form-control" min="1" max="50">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="FIXED_MARGIN_PER_TRADE_USDT">Margen por Trade (USDT)</label>
                                <input type="number" id="FIXED_MARGIN_PER_TRADE_USDT" class="form-control" step="0.1" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="NUM_SYMBOLS_TO_SCAN">S√≠mbolos a Escanear</label>
                                <input type="number" id="NUM_SYMBOLS_TO_SCAN" class="form-control" min="1" max="500">
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="saveConfig(this, 'global')" style="margin-top: 1rem;">
                            <i class="fas fa-save"></i> Guardar Configuraci√≥n Global
                        </button>
                    </div>

                    <div id="strategy-config" class="tab-content">
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="ATR_MULT_SL">Multiplicador SL (ATR)</label>
                                <input type="number" id="ATR_MULT_SL" class="form-control" step="0.1" min="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="ATR_MULT_TP">Multiplicador TP (ATR)</label>
                                <input type="number" id="ATR_MULT_TP" class="form-control" step="0.1" min="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="FAST_EMA">EMA R√°pida</label>
                                <input type="number" id="FAST_EMA" class="form-control" min="1" max="50">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="SLOW_EMA">EMA Lenta</label>
                                <input type="number" id="SLOW_EMA" class="form-control" min="1" max="100">
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="saveConfig(this, 'strategy')" style="margin-top: 1rem;">
                            <i class="fas fa-save"></i> Guardar Configuraci√≥n de Estrategia
                        </button>
                    </div>

                    <div id="trailing-config" class="tab-content">
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="TRAILING_STOP_ACTIVATION">Activaci√≥n Trailing Stop (%)</label>
                                <input type="number" id="TRAILING_STOP_ACTIVATION" class="form-control" step="0.1" min="0.1" max="10">
                                <small>Porcentaje de ganancia sin apalancamiento para activar el trailing stop.</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="TRAILING_STOP_PERCENTAGE">Retroceso Trailing Stop (%)</label>
                                <input type="number" id="TRAILING_STOP_PERCENTAGE" class="form-control" step="0.1" min="0.1" max="10">
                                <small>Porcentaje de retroceso desde el m√°ximo para cerrar la posici√≥n.</small>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="saveConfig(this, 'trailing')" style="margin-top: 1rem;">
                            <i class="fas fa-save"></i> Guardar Configuraci√≥n Trailing Stop
                        </button>
                    </div>

                    <div id="manual-config" class="tab-content">
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="manual-symbol">S√≠mbolo</label>
                                <input type="text" id="manual-symbol" class="form-control" placeholder="BTCUSDT">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="manual-side">Direcci√≥n</label>
                                <select id="manual-side" class="form-control">
                                    <option value="LONG">üü¢ LONG</option>
                                    <option value="SHORT">üî¥ SHORT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="manual-margin">Margen (USDT)</label>
                                <input type="number" id="manual-margin" class="form-control" value="10" min="1" step="0.1">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="executeManualTrade(this)" style="margin-top: 1rem;">
                            <i class="fas fa-rocket"></i> Ejecutar Trade Manual
                        </button>
                    </div>
                </div>
            </div>

            <div class="card grid-col-span-12">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-terminal"></i> Registro de Actividad</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="clearLogs()"><i class="fas fa-trash"></i> Limpiar</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="log-container" id="log-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmation-modal">
        <div class="modal-content">
            <h3 id="modal-title">Confirmar Acci√≥n</h3>
            <p id="modal-body">¬øEst√°s seguro?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-cancel-btn">Cancelar</button>
                <button class="btn btn-danger" id="modal-confirm-btn">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // Variables globales
        const API_BASE_URL = '';
        const socket = io(window.location.origin);
        let performanceChart = null;
        let currentTheme = 'light';
        let positionsData = [];
        let tradesData = [];
        let trailingStopData = {};
        
        // Inicializaci√≥n cuando se carga la p√°gina
        window.onload = function() {
            initializeTheme();
            initializeCharts();
            loadInitialData();
            setupEventListeners();
        };

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            const body = document.body;
            const themeIcon = document.getElementById('theme-toggle').querySelector('i');
            
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                body.classList.remove('dark-mode');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
            if (performanceChart) {
                performanceChart.options.scales.x.ticks.color = theme === 'dark' ? '#D1D5DB' : '#111827';
                performanceChart.options.scales.y.ticks.color = theme === 'dark' ? '#D1D5DB' : '#111827';
                performanceChart.update();
            }
        }

        function initializeCharts() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Balance',
                        data: [],
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { callback: value => formatCurrency(value) }
                        }
                    }
                }
            });
            setTheme(currentTheme);
        }

        function loadInitialData() {
            fetchInitialState();
            loadTrailingStopData();
            loadPerformanceMetrics();
            loadTradeHistory();
        }

        function setupEventListeners() {
            document.getElementById('modal-cancel-btn').addEventListener('click', () => {
                document.getElementById('confirmation-modal').classList.remove('visible');
            });
            document.getElementById('position-search').addEventListener('input', filterPositions);
            document.getElementById('trade-search').addEventListener('input', filterTrades);
        }

        function changeTradeTab(tabElement, period) {
            document.querySelectorAll('#trade-tabs .tab').forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
            
            let dateFilter = '';
            if (period === 'today') {
                dateFilter = new Date().toISOString().split('T')[0];
            }
            loadTradeHistory(1, dateFilter);
        }

        function changeConfigTab(tabElement, tabName) {
            document.querySelectorAll('#config-tabs .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            tabElement.classList.add('active');
            document.getElementById(tabName + '-config').classList.add('active');
        }

        function formatCurrency(value, decimals = 2) { 
            return parseFloat(value || 0).toFixed(decimals); 
        }

        function updateUI(state) {
            const isRunning = state.running;
            document.getElementById('status-message').textContent = state.status_message || 'Detenido';
            document.getElementById('status-dot').classList.toggle('running', isRunning);
            document.getElementById('start-btn').disabled = isRunning;
            document.getElementById('stop-btn').disabled = !isRunning;
            
            document.getElementById('header-balance').textContent = `${formatCurrency(state.balance)} USDT`;
            document.getElementById('balance-stat').textContent = formatCurrency(state.balance);
            document.getElementById('investment-stat').textContent = formatCurrency(state.total_investment_usd);
            
            const openPositions = Object.keys(state.open_positions || {}).length;
            const maxPositions = state.config?.MAX_CONCURRENT_POS || 10;
            document.getElementById('positions-stat').textContent = `${openPositions}/${maxPositions}`;
            document.getElementById('positions-footer').textContent = `Activas: ${openPositions}`;
            
            const totalUnrealizedPnl = Object.values(state.open_positions || {}).reduce((acc, pos) => acc + parseFloat(pos.unRealizedProfit || pos.unrealizedProfit || 0), 0);
            const unrealizedPnlEl = document.getElementById('unrealized-pnl-stat');
            unrealizedPnlEl.textContent = formatCurrency(totalUnrealizedPnl);
            unrealizedPnlEl.className = `stat-value ${totalUnrealizedPnl >= 0 ? 'positive' : 'negative'}`;
            
            const perf = state.performance_stats || {};
            const realizedPnlEl = document.getElementById('realized-pnl-stat');
            realizedPnlEl.textContent = formatCurrency(perf.realized_pnl);
            realizedPnlEl.className = `stat-value ${perf.realized_pnl >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('trades-stat').textContent = perf.trades_count || 0;
            document.getElementById('trades-footer').textContent = `G: ${perf.wins || 0} / P: ${perf.losses || 0}`;
            
            document.getElementById('win-rate-stat').textContent = formatCurrency(perf.win_rate || 0) + '%';
            document.getElementById('avg-win-stat').textContent = formatCurrency(perf.avg_win || 0);
            document.getElementById('avg-loss-stat').textContent = formatCurrency(perf.avg_loss || 0);
            
            let profitFactor = perf.profit_factor || 0;
            document.getElementById('profit-factor-stat').textContent = profitFactor === Infinity ? '‚àû' : formatCurrency(profitFactor, 2);
            
            if (state.config) {
                Object.keys(state.config).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = state.config[key];
                });
            }
            
            positionsData = Object.values(state.open_positions || {});
            updatePositionsTable(positionsData);
            
            updatePerformanceChart(state.balance);
        }

        function updatePositionsTable(positions) {
            const tbody = document.getElementById('positions-tbody');
            tbody.innerHTML = positions.length === 0 
                ? '<tr><td colspan="8" style="text-align:center; padding: 2rem;">No hay posiciones abiertas.</td></tr>'
                : positions.map(pos => {
                    const pnl = parseFloat(pos.unRealizedProfit || pos.unrealizedProfit || 0);
                    const side = parseFloat(pos.positionAmt) > 0 ? 'LONG' : 'SHORT';
                    const entryPrice = parseFloat(pos.entryPrice);
                    const markPrice = parseFloat(pos.markPrice) || 0;
                    const priceChange = entryPrice > 0 ? ((markPrice - entryPrice) / entryPrice) * 100 : 0;
                    
                    const trailingInfo = trailingStopData[pos.symbol] || {};
                    const trailingStatus = trailingInfo.activated ? 
                        `<span class="badge badge-success">Activo @ ${formatCurrency(trailingInfo.current_stop, 4)}</span>` : 
                        `<span class="badge badge-secondary">Inactivo</span>`;
                    
                    return `<tr>
                        <td><strong>${pos.symbol}</strong></td>
                        <td><span class="${side === 'LONG' ? 'positive' : 'negative'}">${side}</span></td>
                        <td>${formatCurrency(Math.abs(pos.positionAmt), 4)}</td>
                        <td>${formatCurrency(entryPrice, 4)}</td>
                        <td>${formatCurrency(markPrice, 4)} <span class="${priceChange >= 0 ? 'positive' : 'negative'}">(${formatCurrency(priceChange)}%)</span></td>
                        <td id="pnl-${pos.symbol}" class="${pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pnl)}</td>
                        <td>${trailingStatus}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="confirmClosePosition('${pos.symbol}')">
                                <i class="fas fa-times"></i> Cerrar
                            </button>
                        </td>
                    </tr>`;
                }).join('');
        }

        function filterPositions() {
            const searchTerm = document.getElementById('position-search').value.toLowerCase();
            const filteredPositions = positionsData.filter(pos => 
                pos.symbol.toLowerCase().includes(searchTerm)
            );
            updatePositionsTable(filteredPositions);
        }

        async function loadTradeHistory(page = 1, date = '', symbol = '') {
            try {
                const response = await fetch(`/api/trade_history?page=${page}&date=${date}&symbol=${symbol}`);
                const data = await response.json();
                tradesData = data.trades;
                updateTradesTable(tradesData);
            } catch (e) {
                console.error("Error loading trade history:", e);
                document.getElementById('trades-tbody').innerHTML = '<tr><td colspan="7" class="text-center error">Error al cargar historial.</td></tr>';
            }
        }
        
        function updateTradesTable(trades) {
            const tbody = document.getElementById('trades-tbody');
            tbody.innerHTML = trades.length === 0
                ? '<tr><td colspan="7" style="text-align:center; padding: 2rem;">No hay trades para mostrar.</td></tr>'
                : trades.map(t => {
                    const pnl = parseFloat(t.pnl || 0);
                    const roe = parseFloat(t.roe || 0);
                    return `<tr>
                        <td>${new Date(t.timestamp).toLocaleString()}</td>
                        <td><strong>${t.symbol}</strong></td>
                        <td><span class="${t.side === 'LONG' ? 'positive' : 'negative'}">${t.side}</span></td>
                        <td>${formatCurrency(t.quantity, 4)}</td>
                        <td class="${pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pnl)}</td>
                        <td class="${roe >= 0 ? 'positive' : 'negative'}">${formatCurrency(roe)}%</td>
                        <td>${t.closeType || 'N/A'}</td>
                    </tr>`;
                }).join('');
        }

        function filterTrades() {
            const searchTerm = document.getElementById('trade-search').value.toLowerCase();
            loadTradeHistory(1, '', searchTerm);
        }

        function updatePerformanceChart(balance) {
            if (!performanceChart || !balance) return;
            
            const now = new Date();
            const timeLabel = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
            
            performanceChart.data.labels.push(timeLabel);
            performanceChart.data.datasets[0].data.push(balance);
            
            const maxDataPoints = 30;
            if (performanceChart.data.labels.length > maxDataPoints) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
            }
            performanceChart.update();
        }

        function addLogEntry(message, level = 'info') {
            const logContainer = document.getElementById('log-container');
            const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const time = new Date().toLocaleTimeString();
            let logClass = 'log-' + level;
            
            logContainer.innerHTML += `<div class="${logClass}"><span style="color: #6B7280;">[${time}]</span> ${sanitizedMessage}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i> ${message}`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }, 10);
        }

        async function apiCall(endpoint, options = {}, button = null) {
            const originalText = button ? button.innerHTML : '';
            if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="loader"></span>';
            }
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Error en la petici√≥n');
                if (data.message) showToast(data.message, 'success');
                return data;
            } catch (error) {
                showToast(error.message, 'error');
                addLogEntry(`‚ùå Error API (${endpoint}): ${error.message}`, 'error');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
        }

        async function startBot(btn) { apiCall('/api/start', { method: 'POST' }, btn); }
        async function stopBot(btn) { apiCall('/api/stop', { method: 'POST' }, btn); }
        
        async function saveConfig(btn, type) {
            const keys = {
                'global': ['LEVERAGE', 'MAX_CONCURRENT_POS', 'FIXED_MARGIN_PER_TRADE_USDT', 'NUM_SYMBOLS_TO_SCAN'],
                'strategy': ['ATR_MULT_SL', 'ATR_MULT_TP', 'FAST_EMA', 'SLOW_EMA'],
                'trailing': ['TRAILING_STOP_ACTIVATION', 'TRAILING_STOP_PERCENTAGE']
            }[type] || [];
                
            const config = keys.reduce((acc, key) => {
                acc[key] = document.getElementById(key).value;
                return acc;
            }, {});
            
            await apiCall('/api/update_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            }, btn);
        }

        async function executeManualTrade(btn) {
            const trade = {
                symbol: document.getElementById('manual-symbol').value.toUpperCase(),
                side: document.getElementById('manual-side').value,
                margin: document.getElementById('manual-margin').value,
            };
            if (!trade.symbol) return showToast('Por favor, introduce un s√≠mbolo.', 'error');
            
            await apiCall('/api/manual_trade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(trade)
            }, btn);
        }

        function confirmClosePosition(symbol) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('modal-title').textContent = `Cerrar Posici√≥n`;
            document.getElementById('modal-body').textContent = `¬øEst√° seguro que desea cerrar la posici√≥n en ${symbol}?`;
            modal.classList.add('visible');

            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.onclick = async () => {
                modal.classList.remove('visible');
                await apiCall('/api/close_position', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
            };
        }

        async function fetchInitialState() {
            try {
                const initialState = await apiCall('/api/status');
                if (initialState) updateUI(initialState);
            } catch (e) { console.error("Error al cargar estado inicial", e); }
        }

        async function loadTrailingStopData() {
            try {
                const response = await fetch('/api/trailing_stop_data');
                if (response.ok) trailingStopData = await response.json();
            } catch (e) { console.error("Error loading trailing stop data:", e); }
        }

        async function loadPerformanceMetrics() {
            const symbol = document.getElementById('performance-symbol').value;
            const response = await fetch(`/api/performance_metrics?symbol=${symbol}&hours=24`);
            const metrics = await response.json();

            const container = document.getElementById('performance-metrics');
            if (metrics.length === 0) {
                container.innerHTML = '<p style="text-align:center">No hay datos de rendimiento disponibles</p>';
                return;
            }
            
            const latestMetrics = Object.values(metrics.reduce((acc, m) => {
                if (!acc[m.symbol] || new Date(m.timestamp) > new Date(acc[m.symbol].timestamp)) {
                    acc[m.symbol] = m;
                }
                return acc;
            }, {}));
            
            container.innerHTML = latestMetrics.map(m => `
                <div class="performance-card">
                    <h4>${m.symbol}</h4>
                    <div class="stat-grid">
                        <div>Win Rate: <span class="${m.win_rate > 0.5 ? 'positive' : 'negative'}">${(m.win_rate * 100).toFixed(2)}%</span></div>
                        <div>Profit Factor: <span class="${m.profit_factor > 1 ? 'positive' : 'negative'}">${m.profit_factor.toFixed(2)}</span></div>
                        <div>Leverage Rec: <strong>${m.recommended_leverage}x</strong></div>
                        <div>Efectividad: ${m.strategy_effectiveness.toFixed(2)}</div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="autoAdjustLeverage('${m.symbol}', this)" style="margin-top: 0.5rem;">
                        Ajustar Leverage
                    </button>
                </div>
            `).join('');
        }

        async function autoAdjustLeverage(symbol, btn) {
            await apiCall('/api/auto_adjust_leverage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol })
            }, btn);
        }

        function refreshData() {
            fetchInitialState();
            loadTrailingStopData();
            loadPerformanceMetrics();
            loadTradeHistory();
            showToast('Datos actualizados', 'success');
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            addLogEntry('Registros limpiados manualmente', 'info');
        }

        socket.on('connect', () => addLogEntry('‚úÖ Conectado al servidor.', 'success'));
        socket.on('disconnect', () => addLogEntry('‚ùå Desconectado del servidor.', 'warning'));
        socket.on('connect_error', (err) => addLogEntry(`‚ùå Error de conexi√≥n: ${err.message}`, 'error'));
        
        socket.on('status_update', (data) => {
            updateUI(data);
            loadTradeHistory(); // Refresh trade history on status update
        });
        
        socket.on('config_updated', (newConfig) => {
            addLogEntry('‚öôÔ∏è Configuraci√≥n actualizada desde el servidor.', 'info');
            Object.keys(newConfig).forEach(key => {
                const el = document.getElementById(key);
                if (el) el.value = newConfig[key];
            });
        });
        
        socket.on('log_update', (data) => addLogEntry(data.message, data.level.toLowerCase()));
        
        socket.on('pnl_update', (pnlData) => {
            Object.entries(pnlData).forEach(([symbol, pnl]) => {
                const pnlCell = document.getElementById(`pnl-${symbol}`);
                if (pnlCell) {
                    pnlCell.textContent = formatCurrency(pnl);
                    pnlCell.className = pnl >= 0 ? 'positive' : 'negative';
                }
            });
        });

        // Load symbols for performance dropdown
        apiCall('/api/positions').then(data => {
            const symbols = Object.keys(data.positions || {});
            const select = document.getElementById('performance-symbol');
            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
            });
        });
    </script>
</body>
</html>